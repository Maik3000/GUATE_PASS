AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  GUATEPASS - Sistema de Cobro Automatizado de Peajes
  Slice #1: Carga inicial de datos desde CSV
  Slice #2: API de consulta de usuarios
  Slice #3: Webhook de peajes y EventBridge
  Slice #4: Step Functions - Orquestación de transacciones

Globals:
  Function:
    Timeout: 30
    MemorySize: 256
    Runtime: python3.11
    Tracing: Active
    Environment:
      Variables:
        POWERTOOLS_SERVICE_NAME: guatepass
        LOG_LEVEL: INFO

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - prod
    Description: Ambiente de despliegue

Resources:
  # ========================================
  # S3 BUCKET - Almacenamiento de datos iniciales
  # ========================================
  GuatepassDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub guatepass-data-${Environment}-${AWS::AccountId}
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldVersions
            Status: Enabled
            NoncurrentVersionExpirationInDays: 30
      Tags:
        - Key: Project
          Value: GUATEPASS
        - Key: Environment
          Value: !Ref Environment

  # ========================================
  # DYNAMODB TABLE - Usuarios
  # ========================================
  GuatepassUsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub GuatepassUsers-${Environment}
      BillingMode: PAY_PER_REQUEST  # Serverless, escala automáticamente
      AttributeDefinitions:
        - AttributeName: placa
          AttributeType: S
        - AttributeName: tag_id
          AttributeType: S
      KeySchema:
        - AttributeName: placa
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: TagIndex
          KeySchema:
            - AttributeName: tag_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      Tags:
        - Key: Project
          Value: GUATEPASS
        - Key: Environment
          Value: !Ref Environment

  # ========================================
  # DYNAMODB TABLE - Catálogo de Peajes (Slice #3)
  # ========================================
  GuatepassTollsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub GuatepassTolls-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: peaje_id
          AttributeType: S
      KeySchema:
        - AttributeName: peaje_id
          KeyType: HASH
      Tags:
        - Key: Project
          Value: GUATEPASS
        - Key: Environment
          Value: !Ref Environment

  # ========================================
  # DYNAMODB TABLE - Transacciones (Slice #4)
  # ========================================
  GuatepassTransactionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub GuatepassTransactions-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: transaction_id
          AttributeType: S
        - AttributeName: placa
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: S
      KeySchema:
        - AttributeName: transaction_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: PlacaTimestampIndex
          KeySchema:
            - AttributeName: placa
              KeyType: HASH
            - AttributeName: timestamp
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      Tags:
        - Key: Project
          Value: GUATEPASS
        - Key: Environment
          Value: !Ref Environment

  # ========================================
  # EVENTBRIDGE BUS - Bus de eventos (Slice #3)
  # ========================================
  GuatepassEventBus:
    Type: AWS::Events::EventBus
    Properties:
      Name: !Sub guatepass-bus-${Environment}
      Tags:
        - Key: Project
          Value: GUATEPASS
        - Key: Environment
          Value: !Ref Environment

  # ========================================
  # LAMBDA FUNCTION - Importar Usuarios desde CSV
  # ========================================
  ImportUsersFunction:
    Type: AWS::Serverless::Function
    DependsOn: GuatepassUsersTable
    Properties:
      FunctionName: !Sub guatepass-import-users-${Environment}
      CodeUri: ../src/import_users/
      Handler: app.lambda_handler
      Description: Importa usuarios desde archivo CSV en S3 a DynamoDB
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref GuatepassUsersTable
          ENVIRONMENT: !Ref Environment
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref GuatepassDataBucket
        - DynamoDBCrudPolicy:
            TableName: !Ref GuatepassUsersTable
      Tags:
        Project: GUATEPASS
        Environment: !Ref Environment

  # ========================================
  # API GATEWAY - Slice #2
  # ========================================
  GuatepassApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub guatepass-api-${Environment}
      StageName: !Ref Environment
      Cors:
        AllowMethods: "'GET, POST, PUT, DELETE, OPTIONS'"
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
        AllowOrigin: "'*'"
      TracingEnabled: true
      Tags:
        Project: GUATEPASS
        Environment: !Ref Environment

  # ========================================
  # LAMBDA FUNCTION - Get User By Placa
  # ========================================
  GetUserByPlacaFunction:
    Type: AWS::Serverless::Function
    DependsOn: GuatepassUsersTable
    Properties:
      FunctionName: !Sub guatepass-get-user-${Environment}
      CodeUri: ../src/get_user_by_placa/
      Handler: app.lambda_handler
      Description: Consulta información de un usuario por su placa
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref GuatepassUsersTable
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref GuatepassUsersTable
      Events:
        GetUser:
          Type: Api
          Properties:
            RestApiId: !Ref GuatepassApi
            Path: /users/{placa}
            Method: GET
      Tags:
        Project: GUATEPASS
        Environment: !Ref Environment

  # ========================================
  # LAMBDA FUNCTION - Get Tag By Placa
  # ========================================
  GetTagByPlacaFunction:
    Type: AWS::Serverless::Function
    DependsOn: GuatepassUsersTable
    Properties:
      FunctionName: !Sub guatepass-get-tag-${Environment}
      CodeUri: ../src/get_tag_by_placa/
      Handler: app.lambda_handler
      Description: Consulta información del Tag asociado a una placa
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref GuatepassUsersTable
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref GuatepassUsersTable
      Events:
        GetTag:
          Type: Api
          Properties:
            RestApiId: !Ref GuatepassApi
            Path: /users/{placa}/tag
            Method: GET
      Tags:
        Project: GUATEPASS
        Environment: !Ref Environment

  # ========================================
  # LAMBDA FUNCTION - Ingest Toll (Slice #3)
  # ========================================
  IngestTollFunction:
    Type: AWS::Serverless::Function
    DependsOn: GuatepassEventBus
    Properties:
      FunctionName: !Sub guatepass-ingest-toll-${Environment}
      CodeUri: ../src/ingest_toll/
      Handler: app.lambda_handler
      Description: Recibe eventos de paso por peaje y los publica a EventBridge
      Environment:
        Variables:
          EVENT_BUS_NAME: !Ref GuatepassEventBus
          ENVIRONMENT: !Ref Environment
      Policies:
        - EventBridgePutEventsPolicy:
            EventBusName: !Ref GuatepassEventBus
      Events:
        WebhookToll:
          Type: Api
          Properties:
            RestApiId: !Ref GuatepassApi
            Path: /webhook/toll
            Method: POST
      Tags:
        Project: GUATEPASS
        Environment: !Ref Environment

  # ========================================
  # LAMBDA FUNCTION - Resolve User Profile (Slice #3/4)
  # ========================================
  ResolveUserProfileFunction:
    Type: AWS::Serverless::Function
    DependsOn: 
      - GuatepassUsersTable
      - GuatepassEventBus
    Properties:
      FunctionName: !Sub guatepass-resolve-user-${Environment}
      CodeUri: ../src/resolve_user/
      Handler: app.lambda_handler
      Description: Determina la modalidad del usuario al pasar por peaje e inicia Step Function
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref GuatepassUsersTable
          STATE_MACHINE_ARN: !Ref GuatepassProcessTollStateMachine
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref GuatepassUsersTable
        - Statement:
            - Effect: Allow
              Action:
                - states:StartExecution
              Resource: !Ref GuatepassProcessTollStateMachine
      Events:
        TollDetectedEvent:
          Type: EventBridgeRule
          Properties:
            EventBusName: !Ref GuatepassEventBus
            Pattern:
              source:
                - guatepass.toll
              detail-type:
                - TollDetected
      Tags:
        Project: GUATEPASS
        Environment: !Ref Environment

  # ========================================
  # LAMBDA FUNCTION - Calculate Toll Fare (Slice #4)
  # ========================================
  CalculateTollFareFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub guatepass-calculate-fare-${Environment}
      CodeUri: ../src/calculate_toll_fare/
      Handler: app.lambda_handler
      Description: Calcula la tarifa del peaje según modalidad
      Environment:
        Variables:
          ENVIRONMENT: !Ref Environment
      Tags:
        Project: GUATEPASS
        Environment: !Ref Environment

  # ========================================
  # LAMBDA FUNCTION - Record Transaction (Slice #4)
  # ========================================
  RecordTransactionFunction:
    Type: AWS::Serverless::Function
    DependsOn: GuatepassTransactionsTable
    Properties:
      FunctionName: !Sub guatepass-record-transaction-${Environment}
      CodeUri: ../src/record_transaction/
      Handler: app.lambda_handler
      Description: Registra la transacción en DynamoDB
      Environment:
        Variables:
          TRANSACTIONS_TABLE_NAME: !Ref GuatepassTransactionsTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref GuatepassTransactionsTable
      Tags:
        Project: GUATEPASS
        Environment: !Ref Environment

  # ========================================
  # LAMBDA FUNCTION - Update Balance (Slice #4)
  # ========================================
  UpdateBalanceFunction:
    Type: AWS::Serverless::Function
    DependsOn: GuatepassUsersTable
    Properties:
      FunctionName: !Sub guatepass-update-balance-${Environment}
      CodeUri: ../src/update_balance/
      Handler: app.lambda_handler
      Description: Actualiza el balance del usuario después de la transacción
      Environment:
        Variables:
          USERS_TABLE_NAME: !Ref GuatepassUsersTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref GuatepassUsersTable
      Tags:
        Project: GUATEPASS
        Environment: !Ref Environment

  # ========================================
  # CLOUDWATCH LOG GROUPS
  # ========================================
  ImportUsersLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/${ImportUsersFunction}
      RetentionInDays: 7

  GetUserByPlacaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/${GetUserByPlacaFunction}
      RetentionInDays: 7

  GetTagByPlacaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/${GetTagByPlacaFunction}
      RetentionInDays: 7

  IngestTollLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/${IngestTollFunction}
      RetentionInDays: 7

  ResolveUserProfileLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/${ResolveUserProfileFunction}
      RetentionInDays: 7

  CalculateTollFareLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/${CalculateTollFareFunction}
      RetentionInDays: 7

  RecordTransactionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/${RecordTransactionFunction}
      RetentionInDays: 7

  UpdateBalanceLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/lambda/${UpdateBalanceFunction}
      RetentionInDays: 7

  # ========================================
  # STEP FUNCTIONS STATE MACHINE (Slice #4)
  # ========================================
  GuatepassProcessTollStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Name: !Sub guatepass-process-toll-${Environment}
      Type: STANDARD
      DefinitionUri: ../src/stepfunctions/process_toll.asl.json
      DefinitionSubstitutions:
        CalculateTollFareFunctionArn: !GetAtt CalculateTollFareFunction.Arn
        RecordTransactionFunctionArn: !GetAtt RecordTransactionFunction.Arn
        UpdateBalanceFunctionArn: !GetAtt UpdateBalanceFunction.Arn
      Policies:
        - LambdaInvokePolicy:
            FunctionName: !Ref CalculateTollFareFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref RecordTransactionFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref UpdateBalanceFunction
        - CloudWatchLogsFullAccess
      Logging:
        Level: ALL
        IncludeExecutionData: true
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt ProcessTollStateMachineLogGroup.Arn
      Tracing:
        Enabled: true
      Tags:
        Project: GUATEPASS
        Environment: !Ref Environment

  ProcessTollStateMachineLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/stepfunctions/guatepass-process-toll-${Environment}
      RetentionInDays: 7

  # ========================================
  # CLOUDWATCH DASHBOARD - Monitoreo Slice #1
  # ========================================
  GuatepassDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Sub GUATEPASS-Slice1-${Environment}
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Invocations", {"stat": "Sum", "label": "Invocaciones"}],
                  [".", "Errors", {"stat": "Sum", "label": "Errores"}],
                  [".", "Duration", {"stat": "Average", "label": "Duración Promedio"}]
                ],
                "period": 300,
                "stat": "Average",
                "region": "${AWS::Region}",
                "title": "Lambda ImportUsers - Métricas",
                "dimensions": {
                  "FunctionName": ["${ImportUsersFunction}"]
                }
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/DynamoDB", "ConsumedReadCapacityUnits", {"stat": "Sum"}],
                  [".", "ConsumedWriteCapacityUnits", {"stat": "Sum"}]
                ],
                "period": 300,
                "stat": "Average",
                "region": "${AWS::Region}",
                "title": "DynamoDB GuatepassUsers - Capacidad",
                "dimensions": {
                  "TableName": ["${GuatepassUsersTable}"]
                }
              }
            },
            {
              "type": "log",
              "properties": {
                "query": "SOURCE '${ImportUsersLogGroup}'\n| fields @timestamp, @message\n| filter @message like /ERROR/\n| sort @timestamp desc\n| limit 20",
                "region": "${AWS::Region}",
                "title": "Errores Recientes",
                "stacked": false
              }
            }
          ]
        }

  # ========================================
  # CLOUDWATCH ALARMS
  # ========================================
  ImportUsersErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub guatepass-import-users-errors-${Environment}
      AlarmDescription: Alerta cuando la función ImportUsers tiene errores
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref ImportUsersFunction
      TreatMissingData: notBreaching

Outputs:
  DataBucketName:
    Description: Nombre del bucket S3 para datos iniciales
    Value: !Ref GuatepassDataBucket
    Export:
      Name: !Sub ${AWS::StackName}-DataBucket

  UsersTableName:
    Description: Nombre de la tabla DynamoDB de usuarios
    Value: !Ref GuatepassUsersTable
    Export:
      Name: !Sub ${AWS::StackName}-UsersTable

  ImportUsersFunctionArn:
    Description: ARN de la función Lambda ImportUsers
    Value: !GetAtt ImportUsersFunction.Arn
    Export:
      Name: !Sub ${AWS::StackName}-ImportUsersFunction

  DashboardURL:
    Description: URL del Dashboard de CloudWatch
    Value: !Sub https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=GUATEPASS-Slice1-${Environment}
  
  ImportUsersFunctionName:
    Description: Nombre de la función Lambda para configurar trigger S3
    Value: !Ref ImportUsersFunction
    
  SetupS3TriggerCommand:
    Description: Comando para configurar el trigger S3 (ejecutar después del deploy)
    Value: !Sub |
      aws lambda add-permission --function-name ${ImportUsersFunction} --statement-id s3-trigger --action lambda:InvokeFunction --principal s3.amazonaws.com --source-arn arn:aws:s3:::${GuatepassDataBucket} --region ${AWS::Region}
      aws s3api put-bucket-notification-configuration --bucket ${GuatepassDataBucket} --notification-configuration '{"LambdaFunctionConfigurations":[{"LambdaFunctionArn":"'$(aws lambda get-function --function-name ${ImportUsersFunction} --query Configuration.FunctionArn --output text --region ${AWS::Region})'","Events":["s3:ObjectCreated:*"],"Filter":{"Key":{"FilterRules":[{"Name":"prefix","Value":"clientes"},{"Name":"suffix","Value":".csv"}]}}}]}'

  # ========================================
  # OUTPUTS - Slice #2 (API)
  # ========================================
  ApiUrl:
    Description: URL base de la API de GUATEPASS
    Value: !Sub https://${GuatepassApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}
    Export:
      Name: !Sub ${AWS::StackName}-ApiUrl

  ApiId:
    Description: ID del API Gateway
    Value: !Ref GuatepassApi
    Export:
      Name: !Sub ${AWS::StackName}-ApiId

  GetUserEndpoint:
    Description: Endpoint para consultar usuario por placa
    Value: !Sub https://${GuatepassApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}/users/{placa}

  GetTagEndpoint:
    Description: Endpoint para consultar tag por placa
    Value: !Sub https://${GuatepassApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}/users/{placa}/tag

  # ========================================
  # OUTPUTS - Slice #3 (Webhook y EventBridge)
  # ========================================
  WebhookTollEndpoint:
    Description: Endpoint para recibir eventos de paso por peaje
    Value: !Sub https://${GuatepassApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}/webhook/toll

  EventBusName:
    Description: Nombre del EventBridge bus
    Value: !Ref GuatepassEventBus
    Export:
      Name: !Sub ${AWS::StackName}-EventBus

  TollsTableName:
    Description: Nombre de la tabla DynamoDB de peajes
    Value: !Ref GuatepassTollsTable
    Export:
      Name: !Sub ${AWS::StackName}-TollsTable

  # ========================================
  # OUTPUTS - Slice #4 (Step Functions)
  # ========================================
  TransactionsTableName:
    Description: Nombre de la tabla DynamoDB de transacciones
    Value: !Ref GuatepassTransactionsTable
    Export:
      Name: !Sub ${AWS::StackName}-TransactionsTable

  StateMachineArn:
    Description: ARN de la Step Function para procesar transacciones
    Value: !Ref GuatepassProcessTollStateMachine
    Export:
      Name: !Sub ${AWS::StackName}-StateMachine

  StateMachineUrl:
    Description: URL de la consola de la Step Function
    Value: !Sub https://console.aws.amazon.com/states/home?region=${AWS::Region}#/statemachines/view/${GuatepassProcessTollStateMachine}
